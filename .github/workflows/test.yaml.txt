name: Build & Security Test
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: registry.upx.exchange/exchange
  IMAGE_NAME: matching-engine
  IMAGE_TAG: v0.8.3
  COSIGN_KEY: sophielog

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build (Release)
        run: cargo build --release

      - name: Run Unit Tests
        run: cargo test --verbose

      - name: Lint
        run: cargo fmt --all -- --check

      - name: Security Scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          exit-code: 1

      - name: Build Docker Image
        run: |
          docker build -t $REGISTRY/$IMAGE_NAME:$IMAGE_TAG .

      - name: SBOM Generation (Syft)
        uses: anchore/syft-action@v0.17.0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: spdx-json
          output: sbom.json

      - name: Sign Image (Cosign)
        run: |
          echo "${COSIGN_KEY}" > cosign.key
          cosign sign --key cosign.key $REGISTRY/$IMAGE_NAME:$IMAGE_TAG
        env:
          COSIGN_PASSWORD: sophielog

      - name: Verify Signature
        run: |
          cosign verify --key cosign.key $REGISTRY/$IMAGE_NAME:$IMAGE_TAG || exit 1
